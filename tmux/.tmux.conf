# ABOUTME: tmux configuration with Catppuccin theme, Ctrl+Space prefix
# ABOUTME: Ctrl+Arrow pane navigation, Ctrl+1-9 window switching, session persistence

# ============================================
# GENERAL SETTINGS
# ============================================
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -as terminal-features ",*:RGB"

set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g focus-events on
set -sg escape-time 0
set -g display-time 4000
set -g status-interval 5

# Don't exit tmux when closing a session
set -g detach-on-destroy off

# ============================================
# PREFIX KEY: Ctrl+Space
# ============================================
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# ============================================
# PANE NAVIGATION: Ctrl+Arrow (no prefix)
# ============================================
# Smart pane switching with awareness of Neovim splits
# See: https://github.com/mrjones2014/smart-splits.nvim
bind-key -n C-Left if -F "#{@pane-is-vim}" 'send-keys C-Left' 'select-pane -L'
bind-key -n C-Down if -F "#{@pane-is-vim}" 'send-keys C-Down' 'select-pane -D'
bind-key -n C-Up if -F "#{@pane-is-vim}" 'send-keys C-Up' 'select-pane -U'
bind-key -n C-Right if -F "#{@pane-is-vim}" 'send-keys C-Right' 'select-pane -R'

# Copy mode navigation
bind-key -T copy-mode-vi C-Left select-pane -L
bind-key -T copy-mode-vi C-Down select-pane -D
bind-key -T copy-mode-vi C-Up select-pane -U
bind-key -T copy-mode-vi C-Right select-pane -R

# ============================================
# WINDOW SWITCHING: Ctrl+1-9 (no prefix)
# ============================================
bind-key -n C-1 select-window -t 1
bind-key -n C-2 select-window -t 2
bind-key -n C-3 select-window -t 3
bind-key -n C-4 select-window -t 4
bind-key -n C-5 select-window -t 5
bind-key -n C-6 select-window -t 6
bind-key -n C-7 select-window -t 7
bind-key -n C-8 select-window -t 8
bind-key -n C-9 select-window -t 9

# ============================================
# PANE MANAGEMENT
# ============================================
# Split panes (use current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# Resize panes with prefix + H/J/K/L
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Zoom pane
bind z resize-pane -Z

# Kill pane without confirmation
bind x kill-pane

# Swap panes
bind -r '{' swap-pane -U
bind -r '}' swap-pane -D

# ============================================
# WINDOW MANAGEMENT
# ============================================
# New window (use current path)
bind c new-window -c "#{pane_current_path}"

# Rename window
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# ============================================
# SESSION MANAGEMENT
# ============================================
# Session picker with sesh (if installed)
bind T run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^x zoxide ^d kill' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)'
)\""

# Fallback session list (if sesh not installed)
bind s choose-tree -Zs

# Rename session
bind $ command-prompt -p "Rename session:" "rename-session '%%'"

# ============================================
# COPY MODE (Vim-style)
# ============================================
setw -g mode-keys vi

bind [ copy-mode
bind ] paste-buffer

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Copy to system clipboard (macOS)
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"

# ============================================
# CATPPUCCIN MOCHA THEME
# ============================================
# Catppuccin Mocha colors
thm_bg="#1e1e2e"
thm_fg="#cdd6f4"
thm_cyan="#89dceb"
thm_black="#181825"
thm_gray="#313244"
thm_magenta="#cba6f7"
thm_pink="#f5c2e7"
thm_red="#f38ba8"
thm_green="#a6e3a1"
thm_yellow="#f9e2af"
thm_blue="#89b4fa"
thm_orange="#fab387"
thm_black4="#585b70"
thm_lavender="#b4befe"

# Status bar
set -g status-position bottom
set -g status-style "bg=${thm_bg},fg=${thm_fg}"
set -g status-left-length 100
set -g status-right-length 100

# Status left: session name
set -g status-left "#[fg=${thm_bg},bg=${thm_lavender},bold] #S #[fg=${thm_lavender},bg=${thm_bg}]"

# Status right: time
set -g status-right "#[fg=${thm_black4}]%H:%M #[fg=${thm_lavender}]"

# Window status
set -g window-status-format "#[fg=${thm_black4}]  #I #W "
set -g window-status-current-format "#[fg=${thm_lavender},bold]  #I #W "
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=${thm_gray}"
set -g pane-active-border-style "fg=${thm_lavender}"

# Message styling
set -g message-style "bg=${thm_gray},fg=${thm_lavender}"

# Mode styling (copy mode)
set -g mode-style "bg=${thm_gray},fg=${thm_lavender}"

# Clock
set -g clock-mode-colour "${thm_lavender}"

# ============================================
# PLUGINS (TPM)
# ============================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum settings (auto-save and restore)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# ============================================
# AUTO-INSTALL TPM
# ============================================
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
